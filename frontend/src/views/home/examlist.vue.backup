<template>
  <div class="exam-management-container">
    <header class="main-header">
      <div class="title">è€ƒè¯•ç®¡ç†ç³»ç»Ÿ</div>
      <div class="user-info">
        <span>æ¬¢è¿ï¼Œæ•™å¸ˆ</span>
        <button @click="logout">é€€å‡º</button>
      </div>
    </header>

    <div class="main-content">
      <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
      <div class="action-buttons">
        <button @click="showCreateExamDialog = true" class="action-btn create-exam-btn">
           åˆ›å»ºè€ƒè¯•
        </button>
      </div>

      <!-- è€ƒè¯•åˆ—è¡¨åŒºåŸŸ -->
      <div class="exam-list-section">
        <h2>è€ƒè¯•åˆ—è¡¨</h2>
        <div v-if="exams.length === 0" class="no-exams">
          <p>æš‚æ— è€ƒè¯•æ•°æ®</p>
          <p class="hint">è¯·åˆ›å»ºæ–°è€ƒè¯•å¼€å§‹ä½¿ç”¨ç³»ç»Ÿ</p>
        </div>
        <div v-else class="exam-grid">
          <div
            v-for="exam in exams"
            :key="exam.exam_id"
            class="exam-card"
          >
            <div class="exam-header">
              <h3 class="exam-title">{{ exam.exam_name }}</h3>
              <div class="exam-meta">
                <span class="exam-status" :class="'status-' + (exam.status || 'created')">
                  {{ getStatusText(exam.status) }}
                </span>
                <span class="exam-date">
                  {{ formatDate(exam.created_at) }}
                </span>
              </div>
              <div class="exam-description" v-if="exam.description">
                {{ exam.description }}
              </div>
            </div>

            <div class="exam-actions">
              <button @click="manageGrades(exam)" class="exam-action-btn grades-btn">
                <i class="icon">ğŸ“Š</i>
                æˆç»©ç®¡ç†
              </button>
              <button @click="editExam(exam)" class="exam-action-btn edit-btn">
                <i class="icon">âœï¸</i>
                ä¿¡æ¯ç¼–è¾‘
              </button>
              <button @click="confirmDeleteExam(exam)" class="exam-action-btn delete-btn">
                <i class="icon">ğŸ—‘ï¸</i>
                åˆ é™¤
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å¼¹çª—ï¼šåˆ›å»º/ç¼–è¾‘è€ƒè¯• -->
    <div v-if="showCreateExamDialog" class="upload-dialog">
      <div class="dialog-content">
        <h3>{{ isEditMode ? 'ç¼–è¾‘è€ƒè¯•' : 'åˆ›å»ºè€ƒè¯•' }}</h3>
        <label>è€ƒè¯•åç§°ï¼š</label>
        <input v-model="examForm.exam_name" placeholder="è¯·è¾“å…¥è€ƒè¯•åç§°" />
        <label>è€ƒè¯•æè¿°ï¼š</label>
        <textarea v-model="examForm.description" placeholder="è¯·è¾“å…¥è€ƒè¯•æè¿°ï¼ˆå¯é€‰ï¼‰" rows="3"></textarea>
        <label>è€ƒè¯•æ—¥æœŸï¼š</label>
        <input v-model="examForm.exam_date" type="date" />
        <label>è€ƒè¯•çŠ¶æ€ï¼š</label>
        <select v-model="examForm.status">
          <option value="created">å·²åˆ›å»º</option>
          <option value="active">è¿›è¡Œä¸­</option>
          <option value="completed">å·²å®Œæˆ</option>
        </select>
        <div class="dialog-actions">
          <button @click="saveExam" :disabled="!examForm.exam_name" class="primary-btn">
            {{ isEditMode ? 'ä¿å­˜' : 'åˆ›å»º' }}
          </button>
          <button @click="closeCreateExamDialog" class="secondary-btn">å–æ¶ˆ</button>
        </div>
        <div v-if="examSaving" class="saving-message">
          {{ isEditMode ? 'ä¿å­˜ä¸­...' : 'åˆ›å»ºä¸­...' }}
        </div>
        <div v-if="examMsg" :class="['message', examMsg.includes('æˆåŠŸ') ? 'success' : 'error']">
          {{ examMsg }}
        </div>
      </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div v-if="showDeleteConfirm" class="upload-dialog">
      <div class="dialog-content delete-dialog">
        <h3>âš ï¸ ç¡®è®¤åˆ é™¤</h3>
        <div class="delete-warning">
          <p>æ‚¨ç¡®å®šè¦åˆ é™¤è€ƒè¯• <strong>"{{ examToDelete?.exam_name }}"</strong> å—ï¼Ÿ</p>
          <p class="warning-text">åˆ é™¤åå°†æ— æ³•æ¢å¤ï¼Œç›¸å…³çš„è¯•å·å’Œæˆç»©æ•°æ®ä¹Ÿä¼šè¢«æ°¸ä¹…åˆ é™¤ã€‚</p>
        </div>
        <div class="dialog-actions">
          <button @click="deleteExam" class="danger-btn">ç¡®è®¤åˆ é™¤</button>
          <button @click="closeDeleteConfirm" class="secondary-btn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- æˆç»©ç®¡ç†å¼¹çª—ï¼ˆæš‚æ—¶ç•™ç©ºï¼‰ -->
    <div v-if="showGradesDialog" class="upload-dialog">
      <div class="dialog-content">
        <h3>ğŸ“Š æˆç»©ç®¡ç†</h3>
        <div class="grades-placeholder">
          <p>ğŸš§ æˆç»©ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...</p>
          <p>æ•¬è¯·æœŸå¾…åç»­åŠŸèƒ½æ›´æ–°ï¼</p>
        </div>
        <div class="dialog-actions">
          <button @click="closeGradesDialog" class="secondary-btn">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>
</template>
        
        <div class="import-description">
          <p>è¯·ä¸Šä¼ Excelæ–‡ä»¶(.xlsx)ï¼Œæ–‡ä»¶æ ¼å¼è¦æ±‚ï¼š</p>
          <ul>
            <li>ç¬¬ä¸€åˆ—ï¼šå­¦ç”Ÿå§“å</li>
            <li>ç¬¬äºŒåˆ—ï¼šåº§ä½å·</li>
            <li>ç¬¬ä¸‰åˆ—ï¼šå­¦ç”ŸIDï¼ˆå¯é€‰ï¼‰</li>
          </ul>
        </div>
        
        <label>é€‰æ‹©Excelæ–‡ä»¶ï¼š</label>
        <input type="file" @change="onStudentSeatsFileChange" accept=".xlsx" class="file-input" />
        
        <div v-if="studentSeatsPreview.length > 0" class="seats-preview">
          <h4>æ–‡ä»¶é¢„è§ˆï¼š</h4>
          <div class="seats-table">
            <table>
              <thead>
                <tr>
                  <th>å­¦ç”Ÿå§“å</th>
                  <th>åº§ä½å·</th>
                  <th>å­¦ç”ŸID</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(row, index) in studentSeatsPreview.slice(0, 5)" :key="index">
                  <td>{{ row.studentName }}</td>
                  <td>{{ row.seatNumber }}</td>
                  <td>{{ row.studentId || 'è‡ªåŠ¨ç”Ÿæˆ' }}</td>
                </tr>
                <tr v-if="studentSeatsPreview.length > 5">
                  <td colspan="3" class="more-text">è¿˜æœ‰{{ studentSeatsPreview.length - 5 }}é¡¹...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="preview-summary">
            <p>å…± {{ studentSeatsPreview.length }} åå­¦ç”Ÿ</p>
          </div>
        </div>
        
        <div class="dialog-actions">
          <button 
            @click="importStudentSeatsData" 
            :disabled="studentSeatsPreview.length === 0">
            å¯¼å…¥åº§ä½å·
          </button>
          <button @click="closeStudentSeatsDialog">å–æ¶ˆ</button>
        </div>
        <div v-if="uploadingSeats">å¯¼å…¥ä¸­ï¼Œè¯·ç¨å€™...</div>
        <div v-if="seatsMsg" class="seats-import-msg" :class="{'success-msg': seatsImportSuccess}">
          {{ seatsMsg }}
        </div>
      </div>
    </div>

    <!-- å¼¹çª—ï¼šå¯¼å…¥æ ‡å‡†ç­”æ¡ˆ -->
    <div v-if="showStandardAnswersDialog" class="upload-dialog">
      <div class="dialog-content">
        <h3>å¯¼å…¥æ ‡å‡†ç­”æ¡ˆ</h3>
        <p>è€ƒè¯•ï¼š{{ selectedExam?.exam_name }}</p>
        
        <!-- æ˜¾ç¤ºå½“å‰å·²æœ‰çš„å‚è€ƒç­”æ¡ˆ -->
        <div v-if="Object.keys(currentReferenceAnswers).length > 0" class="current-answers">
          <h4>å½“å‰å·²æœ‰æ ‡å‡†ç­”æ¡ˆ ({{ Object.keys(currentReferenceAnswers).length }}é¢˜)</h4>
          <div class="current-answers-preview">
            <div v-for="(answer, qNum) in currentReferenceAnswers" :key="qNum" class="current-answer-item">
              <span class="answer-num">é¢˜{{ qNum }}:</span>
              <span class="answer-text">{{ answer.length > 20 ? answer.substring(0, 20) + '...' : answer }}</span>
            </div>
          </div>
        </div>
        
        <div class="import-options">
          <div class="import-tab" :class="{active: importTab === 'file'}" @click="importTab = 'file'">
            æ–‡ä»¶å¯¼å…¥
          </div>
          <div class="import-tab" :class="{active: importTab === 'manual'}" @click="importTab = 'manual'">
            æ‰‹åŠ¨è¾“å…¥
          </div>
        </div>
        
        <!-- æ–‡ä»¶å¯¼å…¥æ ‡ç­¾ -->
        <div v-if="importTab === 'file'" class="file-import">
          <p class="description">ä¸Šä¼ Excelæ–‡ä»¶(.xlsx)ï¼Œæ–‡ä»¶æ ¼å¼ä¸ºä¸¤åˆ—ï¼š<br>é¢˜å· | æ ‡å‡†ç­”æ¡ˆ</p>
          <input type="file" @change="onAnswerFileChange" accept=".xlsx" class="file-input" />
          
          <div v-if="excelAnswers.length > 0" class="excel-preview">
            <h4>æ–‡ä»¶é¢„è§ˆï¼š</h4>
            <div class="excel-table">
              <table>
                <thead>
                  <tr>
                    <th>é¢˜å·</th>
                    <th>æ ‡å‡†ç­”æ¡ˆ</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(row, index) in excelAnswers.slice(0, 5)" :key="index">
                    <td>{{ row.questionNumber }}</td>
                    <td>{{ row.answer }}</td>
                  </tr>
                  <tr v-if="excelAnswers.length > 5">
                    <td colspan="2" class="more-text">è¿˜æœ‰{{ excelAnswers.length - 5 }}é¡¹...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- æ‰‹åŠ¨è¾“å…¥æ ‡ç­¾ -->
        <div v-if="importTab === 'manual'" class="standard-answers-form">
          <div v-for="(answer, index) in standardAnswersArray" :key="index" class="answer-item">
            <div class="answer-number">é¢˜ç›® {{ index + 1 }}</div>
            <textarea 
              v-model="standardAnswersArray[index].answer" 
              placeholder="è¾“å…¥æ ‡å‡†ç­”æ¡ˆ"
              rows="3"
            ></textarea>
          </div>
          <div class="add-question">
            <button @click="addStandardAnswer">+ æ·»åŠ é¢˜ç›®</button>
          </div>
        </div>
        
        <div class="dialog-actions">
          <button 
            @click="importStandardAnswers" 
            :disabled="!hasValidAnswers && excelAnswers.length === 0">
            ä¿å­˜ç­”æ¡ˆ
          </button>
          <button @click="showStandardAnswersDialog = false">å–æ¶ˆ</button>
        </div>
        <div v-if="uploadingAnswers">å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>
        <div v-if="standardAnswersMsg" class="answer-import-msg" :class="{'success-msg': importSuccess}">
          {{ standardAnswersMsg }}
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'

const router = useRouter()
const exams = ref([])

// è€ƒè¯•åˆ›å»º/ç¼–è¾‘ç›¸å…³
const showCreateExamDialog = ref(false)
const isEditMode = ref(false)
const examSaving = ref(false)
const examMsg = ref('')
const examForm = ref({
  exam_id: null,
  exam_name: '',
  description: '',
  exam_date: '',
  status: 'created'
})

// åˆ é™¤ç¡®è®¤ç›¸å…³
const showDeleteConfirm = ref(false)
const examToDelete = ref(null)
const deletingExam = ref(false)
const deleteMsg = ref('')

// æˆç»©ç®¡ç†ç›¸å…³
const showGradesDialog = ref(false)

// æ ¼å¼åŒ–æ—¥æœŸ
const formatDate = (dateString) => {
  if (!dateString) return ''
  const date = new Date(dateString)
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  })
}

// è·å–çŠ¶æ€æ–‡æœ¬
const getStatusText = (status) => {
  const statusMap = {
    'created': 'å·²åˆ›å»º',
    'active': 'è¿›è¡Œä¸­',
    'completed': 'å·²å®Œæˆ'
  }
  return statusMap[status] || 'å·²åˆ›å»º'
}

// æˆç»©ç®¡ç†å‡½æ•°
const manageGrades = (exam) => {
  selectedExam.value = exam
  showGradesDialog.value = true
}

const closeGradesDialog = () => {
  showGradesDialog.value = false
}

// ç¡®è®¤åˆ é™¤è€ƒè¯•
const confirmDeleteExam = (exam) => {
  examToDelete.value = exam
  showDeleteConfirm.value = true
  deleteMsg.value = ''
}

const closeDeleteConfirm = () => {
  showDeleteConfirm.value = false
  examToDelete.value = null
  deleteMsg.value = ''
}

const deleteExam = async () => {
  if (!examToDelete.value) return

  try {
    const response = await axios.delete(`http://localhost:8000/api/exams/${examToDelete.value.exam_id}`)

    if (response.data.code === 1) {
      // åˆ é™¤æˆåŠŸï¼Œç§»é™¤æœ¬åœ°æ•°ç»„ä¸­çš„è€ƒè¯•
      const index = exams.value.findIndex(exam => exam.exam_id === examToDelete.value.exam_id)
      if (index > -1) {
        exams.value.splice(index, 1)
      }

      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„è€ƒè¯•ï¼Œæ¸…é™¤é€‰ä¸­çŠ¶æ€
      if (selectedExam.value && selectedExam.value.exam_id === examToDelete.value.exam_id) {
        selectedExam.value = null
        showStudentDialog.value = false
      }

      alert('è€ƒè¯•åˆ é™¤æˆåŠŸï¼')
    } else {
      alert('åˆ é™¤å¤±è´¥ï¼š' + (response.data.message || 'æœªçŸ¥é”™è¯¯'))
    }
  } catch (error) {
    console.error('åˆ é™¤è€ƒè¯•å¤±è´¥:', error)
    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
  } finally {
    closeDeleteConfirm()
  }
}

// ä¿®æ”¹æ‰¹é‡AIè¯„åˆ†å‡½æ•°
const batchGradePapers = async () => {
  if (!selectedExam.value || !papers.value.length) return
  
  if (!confirm('ç¡®å®šè¦å¯¹æ‰€æœ‰æœªè¯„åˆ†è¯•å·è¿›è¡ŒAIæ‰¹é‡è¯„åˆ†å—ï¼Ÿ')) {
    return
  }
  
  try {
    // è·å–æ‰€æœ‰æœªè¯„åˆ†æˆ–éƒ¨åˆ†è¯„åˆ†çš„è¯•å·
    const ungradedPapers = papers.value.filter(p => 
      p.gradingStatus === 'ungraded' || p.gradingStatus === 'partial'
    )
    
    if (!ungradedPapers.length) {
      alert('æ²¡æœ‰éœ€è¦è¯„åˆ†çš„è¯•å·')
      return
    }
    
    // è·å–æ ‡å‡†ç­”æ¡ˆ - ä½¿ç”¨æ–°çš„API
    const refAnswersRes = await axios.get(`http://localhost:8000/api/reference-answers/${selectedExam.value.exam_id}`)
    const referenceAnswers = refAnswersRes.data.data || {}
    
    if (Object.keys(referenceAnswers).length === 0) {
      alert('è¯¥è€ƒè¯•è¿˜æ²¡æœ‰æ ‡å‡†ç­”æ¡ˆï¼Œè¯·å…ˆå¯¼å…¥æ ‡å‡†ç­”æ¡ˆ')
      return
    }
    
    alert(`å¼€å§‹å¯¹ ${ungradedPapers.length} ä»½è¯•å·è¿›è¡ŒAIè¯„åˆ†ï¼Œå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…`)
    
    let processedCount = 0
    let successCount = 0
    
    // æ˜¾ç¤ºè¿›åº¦
    const progressMsg = document.createElement('div')
    progressMsg.style.position = 'fixed'
    progressMsg.style.top = '50%'
    progressMsg.style.left = '50%'
    progressMsg.style.transform = 'translate(-50%, -50%)'
    progressMsg.style.background = 'white'
    progressMsg.style.padding = '20px'
    progressMsg.style.borderRadius = '8px'
    progressMsg.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)'
    progressMsg.style.zIndex = '9999'
    progressMsg.innerHTML = `æ­£åœ¨è¯„åˆ†: 0/${ungradedPapers.length}`
    document.body.appendChild(progressMsg)
    
    // é€ä¸€å¯¹è¯•å·è¿›è¡Œè¯„åˆ†
    for (const paper of ungradedPapers) {
      try {
        // è·å–è¯•å·è¯¦æƒ…
        const detailsRes = await axios.get(`http://localhost:8000/api/paper-details/${paper.paper_id}`)
        const details = detailsRes.data.data || []
        
        if (!details.length) {
          processedCount++
          progressMsg.innerHTML = `æ­£åœ¨è¯„åˆ†: ${processedCount}/${ungradedPapers.length}`
          continue
        }
        
        // å‡†å¤‡å­¦ç”Ÿç­”æ¡ˆå’Œé¢˜ç›®ä¿¡æ¯
        const studentAnswers = {}
        const questionTypes = {}
        const totalScores = {}
        
        details.forEach(detail => {
          if (detail.answer_text && detail.question_number) {
            studentAnswers[detail.question_number] = detail.answer_text
            totalScores[detail.question_number] = detail.total_score
            
            // ç®€å•æ¨æ–­é¢˜ç›®ç±»å‹
            if (detail.total_score <= 4) {
              questionTypes[detail.question_number] = 'choice'
            } else if (detail.total_score <= 5) {
              questionTypes[detail.question_number] = 'blank'
            } else {
              questionTypes[detail.question_number] = 'essay'
            }
          }
        })
        
        // å¦‚æœæœ‰ç­”æ¡ˆéœ€è¦è¯„åˆ†
        if (Object.keys(studentAnswers).length > 0) {
          // è°ƒç”¨åç«¯AIè¯„åˆ†API
          const gradeRes = await axios.post('http://localhost:8000/api/ai-grade', {
            exam_id: selectedExam.value.exam_id,
            paper_id: paper.paper_id,
            student_answers: studentAnswers,
            reference_answers: referenceAnswers,
            question_types: questionTypes,
            total_scores: totalScores
          })
          
          // å¦‚æœè¯„åˆ†æˆåŠŸ
          if (gradeRes.data.code === 1 && gradeRes.data.data) {
            // æäº¤è¯„åˆ†ç»“æœ
            await axios.post('http://localhost:8000/api/papers/grade', {
              paper_id: paper.paper_id,
              scores: gradeRes.data.data
            })
            successCount++
          }
        }
        
        processedCount++
        progressMsg.innerHTML = `æ­£åœ¨è¯„åˆ†: ${processedCount}/${ungradedPapers.length}`
      } catch (error) {
        console.error(`è¯•å·è¯„åˆ†å¤±è´¥ (paper_id=${paper.paper_id}):`, error)
        processedCount++
        progressMsg.innerHTML = `æ­£åœ¨è¯„åˆ†: ${processedCount}/${ungradedPapers.length}`
      }
    }
    
    // ç§»é™¤è¿›åº¦æç¤º
    document.body.removeChild(progressMsg)
    
    alert(`AIè¯„åˆ†å®Œæˆï¼æˆåŠŸè¯„åˆ† ${successCount}/${ungradedPapers.length} ä»½è¯•å·ã€‚`)
    
    // é‡æ–°åŠ è½½è¯•å·åˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€
    selectExam(selectedExam.value)
    
  } catch (e) {
    console.error('AIè¯„åˆ†å¤±è´¥', e)
    alert('AIè¯„åˆ†è¿‡ç¨‹ä¸­å‡ºé”™ï¼Œè¯·é‡è¯•')
  }
}

// åˆ¤å·çŠ¶æ€è·å–
const fetchGradingStatus = async (paper) => {
  try {
    const res = await axios.get(`http://localhost:8000/api/paper-details/${paper.paper_id}`)
    const details = res.data.data || []
    if (details.length === 0) {
      paper.gradingStatus = 'ungraded'
      return
    }
    const scores = details.map(d => d.score)
    if (scores.every(s => s === null || s === undefined)) {
      paper.gradingStatus = 'ungraded'
    } else if (scores.every(s => s !== null && s !== undefined)) {
      paper.gradingStatus = 'graded'
    } else {
      paper.gradingStatus = 'partial'
    }
  } catch (e) {
    console.error('è·å–åˆ¤å·çŠ¶æ€å¤±è´¥', e)
    paper.gradingStatus = 'ungraded'
  }
}

const fetchExamProgress = async (examId) => {
  try {
    const res = await axios.get(`http://localhost:8000/api/papers/${examId}`)
    const papers = res.data.data || []
    let graded = 0
    let total = papers.length
    
    // å¹¶å‘è·å–æ¯ä»½è¯•å·çš„åˆ¤å·çŠ¶æ€
    await Promise.all(
      papers.map(async (paper) => {
        const detailRes = await axios.get(`http://localhost:8000/api/paper-details/${paper.paper_id}`)
        const details = detailRes.data.data || []
        if (
          details.length > 0 &&
          details.every(d => d.score !== null && d.score !== undefined)
        ) {
          graded += 1
        }
      })
    )
    examProgressMap.value[examId] = { graded, total }
  } catch (e) {
    console.error('è·å–è€ƒè¯•è¿›åº¦å¤±è´¥', e)
    examProgressMap.value[examId] = { graded: 0, total: 0 }
  }
}

// é€‰æ‹©è€ƒè¯•
const selectExam = (exam) => {
  selectedExam.value = exam
  // è®°å½•é€‰æ‹©çš„è€ƒè¯•ä¿¡æ¯
  localStorage.setItem('lastExamId', exam.exam_id)
  localStorage.setItem('lastExamName', exam.exam_name)
}

// æŸ¥çœ‹è¯•å·åˆ—è¡¨
const viewPapers = (exam) => {
  // è·³è½¬åˆ°è¯•å·åˆ—è¡¨é¡µé¢
  router.push({ 
    path: `/exam/${exam.exam_id}/papers`, 
    query: { examName: exam.exam_name } 
  })
}

// é€‰æ‹©è€ƒè¯•å¹¶å‡†å¤‡å¯¼å…¥ç­”æ¡ˆ
const selectExamForAnswers = (exam) => {
  selectedExam.value = exam
  onShowStandardAnswersDialog()
}

// åˆ›å»ºè€ƒè¯•
const createExam = () => {
  isEditMode.value = false
  examForm.value = {
    exam_id: null,
    exam_name: '',
    description: '',
    exam_date: '',
    status: 'draft'
  }
  showCreateExamDialog.value = true
}

// ç¼–è¾‘è€ƒè¯•
const editExam = (exam) => {
  isEditMode.value = true
  examForm.value = {
    exam_id: exam.exam_id,
    exam_name: exam.exam_name,
    description: exam.description || '',
    exam_date: exam.exam_date || '',
    status: exam.status || 'draft'
  }
  showCreateExamDialog.value = true
}

// ä¿å­˜è€ƒè¯•ï¼ˆåˆ›å»ºæˆ–æ›´æ–°ï¼‰
const saveExam = async () => {
  if (!examForm.value.exam_name.trim()) {
    examMsg.value = 'è¯·è¾“å…¥è€ƒè¯•åç§°'
    return
  }
  
  examSaving.value = true
  examMsg.value = ''
  
  try {
    let response
    
    if (isEditMode.value) {
      // æ›´æ–°è€ƒè¯•
      response = await axios.put(`http://localhost:8000/api/exams/${examForm.value.exam_id}`, {
        exam_name: examForm.value.exam_name,
        description: examForm.value.description,
        exam_date: examForm.value.exam_date,
        status: examForm.value.status
      })
    } else {
      // åˆ›å»ºæ–°è€ƒè¯•
      response = await axios.post('http://localhost:8000/api/exams', {
        exam_name: examForm.value.exam_name,
        description: examForm.value.description,
        exam_date: examForm.value.exam_date,
        status: examForm.value.status
      })
    }
    
    if (response.data.code === 1) {
      examMsg.value = isEditMode.value ? 'è€ƒè¯•æ›´æ–°æˆåŠŸï¼' : 'è€ƒè¯•åˆ›å»ºæˆåŠŸï¼'
      
      // å»¶è¿Ÿå…³é—­å¼¹çª—å¹¶åˆ·æ–°åˆ—è¡¨
      setTimeout(() => {
        closeCreateExamDialog()
        loadExams()
      }, 1500)
    } else {
      examMsg.value = response.data.msg || (isEditMode.value ? 'æ›´æ–°å¤±è´¥' : 'åˆ›å»ºå¤±è´¥')
      examSaving.value = false
    }
  } catch (e) {
    console.error('ä¿å­˜è€ƒè¯•å¤±è´¥', e)
    examMsg.value = isEditMode.value ? 'æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•' : 'åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•'
    examSaving.value = false
  }
}

// åˆ é™¤è€ƒè¯•
const deleteExam = async (exam) => {
  if (!confirm(`ç¡®å®šè¦åˆ é™¤è€ƒè¯• "${exam.exam_name}" å—ï¼Ÿ\nåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼Œç›¸å…³çš„è¯•å·å’Œæˆç»©æ•°æ®ä¹Ÿä¼šè¢«åˆ é™¤ã€‚`)) {
    return
  }
  
  try {
    const response = await axios.delete(`http://localhost:8000/api/exams/${exam.exam_id}`)
    
    if (response.data.code === 1) {
      alert('è€ƒè¯•åˆ é™¤æˆåŠŸï¼')
      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„è€ƒè¯•ï¼Œæ¸…é™¤é€‰ä¸­çŠ¶æ€
      if (selectedExam.value && selectedExam.value.exam_id === exam.exam_id) {
        selectedExam.value = null
      }
      // é‡æ–°åŠ è½½è€ƒè¯•åˆ—è¡¨
      loadExams()
    } else {
      alert(response.data.msg || 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  } catch (e) {
    console.error('åˆ é™¤è€ƒè¯•å¤±è´¥', e)
    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}

// å…³é—­åˆ›å»º/ç¼–è¾‘è€ƒè¯•å¼¹çª—
const closeCreateExamDialog = () => {
  showCreateExamDialog.value = false
  isEditMode.value = false
  examSaving.value = false
  examMsg.value = ''
  examForm.value = {
    exam_id: null,
    exam_name: '',
    description: '',
    exam_date: '',
    status: 'draft'
  }
}

// å¯¼å…¥å­¦ç”Ÿåº§ä½å·
const importStudentSeats = (exam) => {
  selectedExam.value = exam
  showStudentSeatsDialog.value = true
  // é‡ç½®çŠ¶æ€
  studentSeatsPreview.value = []
  seatsMsg.value = ''
  seatsImportSuccess.value = false
}

// å¤„ç†å­¦ç”Ÿåº§ä½å·æ–‡ä»¶ä¸Šä¼ 
const onStudentSeatsFileChange = (e) => {
  const file = e.target.files[0]
  if (!file) return
  
  const reader = new FileReader()
  reader.onload = (event) => {
    try {
      const data = new Uint8Array(event.target.result)
      const workbook = XLSX.read(data, { type: 'array' })
      
      // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]]
      
      // è½¬æ¢ä¸ºJSON
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: ['studentName', 'seatNumber', 'studentId'] })
      
      // ç§»é™¤è¡¨å¤´ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (jsonData.length > 0 && 
          (typeof jsonData[0].studentName === 'string' && 
           typeof jsonData[0].seatNumber === 'string')) {
        jsonData.shift()
      }
      
      // è¿‡æ»¤å’Œæ ¼å¼åŒ–æ•°æ®
      studentSeatsPreview.value = jsonData
        .filter(row => row.studentName !== undefined && row.seatNumber !== undefined)
        .map(row => ({
          studentName: String(row.studentName).trim(),
          seatNumber: String(row.seatNumber).trim(),
          studentId: row.studentId ? String(row.studentId).trim() : null
        }))
        .filter(row => row.studentName !== '' && row.seatNumber !== '')
      
      if (studentSeatsPreview.value.length === 0) {
        seatsMsg.value = 'æœªæ‰¾åˆ°æœ‰æ•ˆçš„å­¦ç”Ÿåº§ä½å·æ•°æ®ï¼Œè¯·æ£€æŸ¥Excelæ ¼å¼'
        seatsImportSuccess.value = false
      }
    } catch (err) {
      console.error('è§£æExcelæ–‡ä»¶å¤±è´¥:', err)
      seatsMsg.value = 'è§£ææ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®'
      seatsImportSuccess.value = false
      studentSeatsPreview.value = []
    }
  }
  
  reader.readAsArrayBuffer(file)
}

// å¯¼å…¥å­¦ç”Ÿåº§ä½å·æ•°æ®
const importStudentSeatsData = async () => {
  if (!selectedExam.value || studentSeatsPreview.value.length === 0) return
  
  uploadingSeats.value = true
  seatsMsg.value = ''
  
  try {
    const response = await axios.post('http://localhost:8000/api/student-seats/import', {
      exam_id: selectedExam.value.exam_id,
      students: studentSeatsPreview.value
    })
    
    if (response.data.code === 1) {
      seatsMsg.value = `æˆåŠŸå¯¼å…¥ ${studentSeatsPreview.value.length} åå­¦ç”Ÿçš„åº§ä½å·ä¿¡æ¯ï¼`
      seatsImportSuccess.value = true
      
      // 2ç§’åå…³é—­å¼¹çª—
      setTimeout(() => {
        closeStudentSeatsDialog()
      }, 2000)
    } else {
      seatsMsg.value = response.data.msg || 'å¯¼å…¥å¤±è´¥'
      seatsImportSuccess.value = false
      uploadingSeats.value = false
    }
  } catch (e) {
    console.error('å¯¼å…¥å­¦ç”Ÿåº§ä½å·å¤±è´¥', e)
    seatsMsg.value = 'å¯¼å…¥å¤±è´¥ï¼Œè¯·é‡è¯•'
    seatsImportSuccess.value = false
    uploadingSeats.value = false
  }
}

// å…³é—­å­¦ç”Ÿåº§ä½å·å¼¹çª—
const closeStudentSeatsDialog = () => {
  showStudentSeatsDialog.value = false
  studentSeatsPreview.value = []
  uploadingSeats.value = false
  seatsMsg.value = ''
  seatsImportSuccess.value = false
}



const logout = () => {
  localStorage.removeItem('username')
  router.push('/login')
}



const onFileChange = (e) => {
  uploadFile.value = e.target.files[0]
}

const handleUpload = async () => {
  if (!uploadExamName.value || !uploadFile.value) return
  uploading.value = true
  uploadMsg.value = ''
  
  try {
    const formData = new FormData()
    formData.append('exam_name', uploadExamName.value)
    formData.append('video', uploadFile.value)
    
    // ä½¿ç”¨æ–°çš„APIç«¯ç‚¹
    const response = await axios.post('http://localhost:8000/api/upload-video', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    })
    
    if (response.data.code === 1) {
      uploadMsg.value = 'ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨å¤„ç†ï¼è¯·ç¨ååˆ·æ–°é¡µé¢æŸ¥çœ‹æ–°è€ƒè¯•ã€‚'
      
      // å¯é€‰ï¼šè‡ªåŠ¨åˆ·æ–°è€ƒè¯•åˆ—è¡¨
      setTimeout(() => {
        showUploadDialog.value = false
        uploadExamName.value = ''
        uploadFile.value = null
        uploading.value = false
        uploadMsg.value = ''
        // é‡æ–°åŠ è½½è€ƒè¯•åˆ—è¡¨
        loadExams()
      }, 2000)
    } else {
      uploadMsg.value = response.data.msg || 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•'
      uploading.value = false
    }
  } catch (e) {
    console.error('ä¸Šä¼ å¤±è´¥', e)
    uploadMsg.value = 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•'
    uploading.value = false
  }
}

const loadExams = async () => {
  try {
    const res = await axios.get('http://localhost:8000/api/exams')
    exams.value = res.data.data || []
    
    // åŠ è½½æ¯ä¸ªè€ƒè¯•çš„è¿›åº¦
    for (const exam of exams.value) {
      fetchExamProgress(exam.exam_id)
    }
  } catch (e) {
    console.error('è·å–è€ƒè¯•åˆ—è¡¨å¤±è´¥', e)
  }
}

const loadCurrentReferenceAnswers = async () => {
  if (!selectedExam.value) return
  
  try {
    const response = await axios.get(`http://localhost:8000/api/reference-answers/${selectedExam.value.exam_id}`)
    if (response.data.code === 1) {
      currentReferenceAnswers.value = response.data.data || {}
      
      // å¦‚æœå·²ç»æœ‰å‚è€ƒç­”æ¡ˆï¼Œé¢„å¡«å……åˆ°è¡¨å•ä¸­
      if (Object.keys(currentReferenceAnswers.value).length > 0) {
        // æ›´æ–°æ‰‹åŠ¨è¾“å…¥è¡¨å•
        standardAnswersArray.value = []
        for (const [qNum, answer] of Object.entries(currentReferenceAnswers.value)) {
          standardAnswersArray.value.push({
            questionNumber: parseInt(qNum),
            answer: answer
          })
        }
        // ç¡®ä¿é¢˜å·æ’åº
        standardAnswersArray.value.sort((a, b) => a.questionNumber - b.questionNumber)
      }
    }
  } catch (e) {
    console.error('è·å–å½“å‰å‚è€ƒç­”æ¡ˆå¤±è´¥', e)
    currentReferenceAnswers.value = {}
  }
}

const onShowStandardAnswersDialog = async () => {
  if (!selectedExam.value) {
    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè€ƒè¯•')
    return
  }
  showStandardAnswersDialog.value = true
  
  // é‡ç½®çŠ¶æ€
  standardAnswersMsg.value = ''
  importSuccess.value = false
  excelAnswers.value = []
  
  // åŠ è½½å½“å‰å‚è€ƒç­”æ¡ˆ
  await loadCurrentReferenceAnswers()
}

onMounted(async () => {
  if (!localStorage.getItem('username')) {
    router.push('/login')
    return
  }
  
  await loadExams()
})
</script>

<style scoped>
.exam-management-container {
  min-height: 100vh;
  width: 100vw;
  background: transparent;
  position: relative;
}

.exam-management-container::before {
  content: "";
  background-image: url('/4.jpg');
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  opacity: 0.9;
}

.main-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(35, 57, 93, 0.9);
  color: #fff;
  padding: 0 32px;
  height: 56px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.title {
  font-size: 1.8rem;
  font-weight: bold;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 16px;
}

.user-info button {
  background: #f39c12;
  color: #fff;
  border: none;
  padding: 6px 16px;
  border-radius: 4px;
  cursor: pointer;
}

.main-content {
  padding: 32px;
  height: calc(100vh - 56px);
  overflow-y: auto;
}

.action-buttons {
  display: flex;
  gap: 20px;
  margin-bottom: 32px;
  justify-content: center;
}

.action-btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.import-video-btn {
  background: #10b981;
  color: white;
}

.import-video-btn:hover {
  background: #059669;
  transform: translateY(-2px);
}

.create-exam-btn {
  background: #3b82f6;
  color: white;
}

.create-exam-btn:hover {
  background: #2563eb;
  transform: translateY(-2px);
}



.exam-list-section {
  background: rgba(255, 255, 255, 0.9);
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.exam-list-section h2 {
  text-align: center;
  margin-bottom: 24px;
  color: #374151;
  font-size: 1.8rem;
}

.no-exams {
  text-align: center;
  padding: 60px 20px;
  color: #6b7280;
}

.no-exams p {
  font-size: 1.2rem;
  margin-bottom: 8px;
}

.hint {
  font-size: 1rem;
  color: #9ca3af;
  font-style: italic;
}

.exam-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 20px;
}

.exam-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}

.exam-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.exam-card.selected {
  border-color: #3b82f6;
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
}

.exam-header {
  margin-bottom: 16px;
}

.exam-title {
  font-size: 1.3rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
}

.exam-progress {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.progress-text {
  font-size: 0.9rem;
  color: #6b7280;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: #e5e7eb;
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #10b981, #059669);
  transition: width 0.3s ease;
}

.exam-actions {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
  gap: 4px;
}

.exam-action-btn {
  padding: 6px 8px;
  border: none;
  border-radius: 4px;
  font-size: 0.8rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.view-papers-btn {
  background: #3b82f6;
  color: white;
}

.view-papers-btn:hover {
  background: #2563eb;
}

.primary-action {
  font-weight: 600;
}

.exam-action-btn.import-answers-btn {
  background: #f3f4f6;
  color: #374151;
  border: 1px solid #d1d5db;
}

.exam-action-btn.import-answers-btn:hover {
  background: #e5e7eb;
}

.import-seats-btn {
  background: #8b5cf6;
  color: white;
}

.import-seats-btn:hover {
  background: #7c3aed;
}

.edit-exam-btn {
  background: #f59e0b;
  color: white;
}

.edit-exam-btn:hover {
  background: #d97706;
}

.delete-exam-btn {
  background: #ef4444;
  color: white;
}

.delete-exam-btn:hover {
  background: #dc2626;
}



.upload-dialog {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000;
}

.dialog-content {
  background: rgba(255, 255, 255, 0.95);
  padding: 32px 24px;
  border-radius: 8px;
  min-width: 320px;
  max-width: 90vw;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.25);
}

.dialog-content h3 {
  margin-top: 0;
  margin-bottom: 16px;
}

.dialog-content label {
  display: block;
  margin: 8px 0;
  font-weight: 500;
}

.dialog-content input,
.dialog-content textarea,
.dialog-content select {
  width: 100%;
  padding: 8px;
  margin-bottom: 16px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 0.9rem;
}

.dialog-content textarea {
  resize: vertical;
  min-height: 60px;
}

.dialog-content select {
  background: white;
  cursor: pointer;
}

.dialog-actions {
  margin-top: 16px;
  display: flex;
  gap: 12px;
}

.dialog-actions button {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.dialog-actions button:first-child {
  background: #3b82f6;
  color: white;
}

.dialog-actions button:last-child {
  background: #e5e7eb;
  color: #374151;
}

.import-options {
  display: flex;
  margin-bottom: 20px;
  border-bottom: 1px solid #e5e7eb;
}

.import-tab {
  padding: 8px 16px;
  cursor: pointer;
  border-bottom: 3px solid transparent;
}

.import-tab.active {
  border-bottom: 3px solid #3b82f6;
  font-weight: 600;
  color: #3b82f6;
}

.file-import {
  margin-bottom: 20px;
}

.description {
  font-size: 0.9rem;
  color: #6b7280;
  margin-bottom: 10px;
}

.file-input {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border: 1px dashed #d1d5db;
  border-radius: 4px;
  background: #f9fafb;
}

.excel-preview {
  margin-top: 16px;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  padding: 12px;
}

.excel-preview h4 {
  margin-top: 0;
  margin-bottom: 8px;
  font-size: 0.9rem;
  color: #4b5563;
}

.excel-table {
  max-height: 200px;
  overflow-y: auto;
}

.excel-table table {
  width: 100%;
  border-collapse: collapse;
}

.excel-table th {
  background: #f3f4f6;
  padding: 8px;
  text-align: left;
  font-weight: 600;
  font-size: 0.85rem;
}

.excel-table td {
  padding: 8px;
  border-top: 1px solid #e5e7eb;
  font-size: 0.85rem;
}

.more-text {
  text-align: center;
  color: #6b7280;
  font-style: italic;
}

.answer-import-msg {
  margin-top: 12px;
  padding: 8px 12px;
  border-radius: 4px;
  background: #fee2e2;
  color: #b91c1c;
}

.success-msg {
  background: #dcfce7;
  color: #166534;
}

.current-answers {
  margin-bottom: 20px;
}

.current-answers-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.current-answer-item {
  background: #f3f4f6;
  padding: 4px 8px;
  border-radius: 4px;
}

.answer-num {
  font-weight: 600;
}

.answer-text {
  margin-left: 8px;
}

.standard-answers-form {
  max-height: 400px;
  overflow-y: auto;
}

.answer-item {
  margin-bottom: 16px;
  padding: 12px;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  background: #f9fafb;
}

.answer-number {
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
}

.add-question {
  text-align: center;
  margin-top: 16px;
}

.add-question button {
  background: #10b981;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
}

.add-question button:hover {
  background: #059669;
}

.import-description {
  background: #f0f9ff;
  border: 1px solid #0ea5e9;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 16px;
}

.import-description p {
  margin: 0 0 8px 0;
  font-weight: 600;
  color: #0c4a6e;
}

.import-description ul {
  margin: 0;
  padding-left: 20px;
}

.import-description li {
  margin-bottom: 4px;
  color: #0369a1;
}

.seats-preview {
  margin-top: 16px;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  padding: 12px;
}

.seats-preview h4 {
  margin-top: 0;
  margin-bottom: 8px;
  font-size: 0.9rem;
  color: #4b5563;
}

.seats-table {
  max-height: 200px;
  overflow-y: auto;
}

.seats-table table {
  width: 100%;
  border-collapse: collapse;
}

.seats-table th {
  background: #f3f4f6;
  padding: 8px;
  text-align: left;
  font-weight: 600;
  font-size: 0.85rem;
}

.seats-table td {
  padding: 8px;
  border-top: 1px solid #e5e7eb;
  font-size: 0.85rem;
}

.preview-summary {
  margin-top: 8px;
  padding: 8px;
  background: #f0f9ff;
  border-radius: 4px;
  text-align: center;
}

.preview-summary p {
  margin: 0;
  font-weight: 600;
  color: #0369a1;
}

.seats-import-msg {
  margin-top: 12px;
  padding: 8px 12px;
  border-radius: 4px;
  background: #fee2e2;
  color: #b91c1c;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .main-content {
    padding: 16px;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .action-btn {
    width: 100%;
  }

  .exam-grid {
    grid-template-columns: 1fr;
  }
  
  .exam-actions {
    grid-template-columns: 1fr 1fr;
    gap: 4px;
  }
  
  .exam-action-btn {
    font-size: 0.75rem;
    padding: 4px 6px;
  }
  
  .dialog-content {
    margin: 10px;
    padding: 20px 16px;
    min-width: auto;
  }
}
</style>